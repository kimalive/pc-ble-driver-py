name: Create Release with Wheels
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.17.10)'
        required: true
        type: string
      tag:
        description: 'Git tag (e.g., v0.17.10)'
        required: true
        type: string
jobs:
  build-x86_64:
    name: Build x86_64 Wheels (Intel macOS)
    runs-on: macos-15-intel  # Updated from macos-13 (deprecated)
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Always use master for building (has latest fixes)
          # The tag is only used for the release name, not the code
          ref: master
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          ./bootstrap-vcpkg.sh

      - name: Install nrf-ble-driver (x64-osx)
        run: |
          ./vcpkg/vcpkg install nrf-ble-driver --triplet x64-osx

      - name: Install build dependencies
        run: |
          # Install SWIG (latest version - our fix works with both 4.3.x and 4.4.0)
          # We include Python.h and moduleobject.h in the %begin block to ensure compatibility
          brew install swig
          # Verify SWIG installation
          swig -version || echo "SWIG not found in PATH"
          which swig || echo "swig command not found"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scikit-build ninja cmake wrapt cryptography

      - name: Build x86_64 wheel
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          CMAKE_TOOLCHAIN_FILE: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
          CMAKE_PREFIX_PATH: ${{ github.workspace }}/vcpkg/installed/x64-osx
        run: |
          # Clean _skbuild to ensure fresh build (prevents cross-version contamination)
          rm -rf _skbuild || true
          # Build wheel with explicit Python detection flags
          python setup.py bdist_wheel --build-type Release -- \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DPYTHON_EXECUTABLE="$(which python)" \
            -DPython3_EXECUTABLE="$(which python)" \
            -DPython3_ROOT_DIR="$(dirname $(dirname $(which python)))" \
            -DPython3_FIND_STRATEGY=LOCATION \
            -DPython3_FIND_REGISTRY=NEVER \
            -DPython3_FIND_VIRTUALENV=ONLY \
            -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON

      - name: Rename wheel to preserve Python version
        if: success()
        run: |
          # Find the wheel that was just built (it will have cp38-abi3 tag internally)
          WHEEL=$(ls -t dist/pc_ble_driver_py-*-cp38-abi3-*x86_64*.whl 2>/dev/null | head -1)
          if [ -z "$WHEEL" ]; then
            # Fallback: try any cp*-abi3 pattern
            WHEEL=$(ls -t dist/pc_ble_driver_py-*-cp*-abi3-*x86_64*.whl 2>/dev/null | head -1)
          fi
          if [ -z "$WHEEL" ]; then
            # Fallback: try without abi3 tag
            WHEEL=$(ls -t dist/pc_ble_driver_py-*-*x86_64*.whl 2>/dev/null | head -1)
          fi
          if [ -n "$WHEEL" ] && [ -f "$WHEEL" ]; then
            # Extract Python version tag (e.g., "3.8" -> "cp38", "3.12" -> "cp312")
            PYTHON_TAG="cp${{ matrix.python-version }}"
            # Remove dots from version for tag (3.10 -> cp310)
            PYTHON_TAG=$(echo "$PYTHON_TAG" | sed 's/\.//g')
            # Get version from package __init__.py (most reliable)
            VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from pc_ble_driver_py import __version__; print(__version__)" 2>/dev/null)
            if [ -z "$VERSION" ]; then
              # Fallback: extract from wheel filename
              BASE_NAME=$(basename "$WHEEL" .whl)
              VERSION=$(echo "$BASE_NAME" | sed -n 's/.*pc_ble_driver_py-\([0-9.]*\)-.*/\1/p')
            fi
            if [ -z "$VERSION" ]; then
              echo "Error: Could not determine package version"
              exit 1
            fi
            # Create new name with correct Python tag
            NEW_WHEEL="dist/pc_ble_driver_py-${VERSION}-${PYTHON_TAG}-abi3-macosx_26_0_x86_64.whl"
            if [ "$WHEEL" != "$NEW_WHEEL" ]; then
              echo "Renaming wheel to preserve Python version:"
              echo "  From: $(basename "$WHEEL")"
              echo "  To:   $(basename "$NEW_WHEEL")"
              mv "$WHEEL" "$NEW_WHEEL"
              WHEEL="$NEW_WHEEL"
            fi
            echo "Final wheel: $WHEEL"
          else
            echo "Error: No wheel found to rename"
            exit 1
          fi

      - name: Bundle dependencies into wheel
        if: success()
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_TRIPLET: x64-osx
        run: |
          # Find the renamed wheel
          PYTHON_TAG="cp${{ matrix.python-version }}"
          PYTHON_TAG=$(echo "$PYTHON_TAG" | sed 's/\.//g')
          WHEEL=$(ls -t dist/pc_ble_driver_py-*-${PYTHON_TAG}-abi3-*x86_64*.whl 2>/dev/null | head -1)
          if [ -z "$WHEEL" ]; then
            # Fallback: try any x86_64 wheel
            WHEEL=$(ls -t dist/pc_ble_driver_py-*-*x86_64*.whl 2>/dev/null | head -1)
          fi
          if [ -n "$WHEEL" ] && [ -f "$WHEEL" ]; then
            echo "Bundling dependencies into: $WHEEL"
            python ${{ github.workspace }}/bundle_into_wheel.py "$WHEEL" || echo "Bundling skipped (optional)"
          else
            echo "Warning: No wheel found to bundle"
          fi

      - name: Upload x86_64 wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-x86_64-py${{ matrix.python-version }}
          path: dist/*.whl
          if-no-files-found: error
          retention-days: 1

  create-release:
    name: Create Release
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create/delete releases
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use master for downloading artifacts (tag is only for release name)
          ref: master
          fetch-depth: 0
          fetch-tags: true

      - name: Download x86_64 wheels
        uses: actions/download-artifact@v4
        with:
          path: wheels/x86_64
          pattern: wheel-x86_64-*
          merge-multiple: true

      - name: Download ARM64 wheels
        uses: actions/download-artifact@v4
        with:
          path: wheels/arm64
          pattern: wheel-arm64-*
          merge-multiple: true

      - name: List downloaded wheels
        run: |
          echo "=== x86_64 wheels ==="
          ls -lh wheels/x86_64/*.whl 2>/dev/null | awk '{print $9, "(" $5 ")"}' || echo "No x86_64 wheels found"
          echo ""
          echo "=== ARM64 wheels ==="
          ls -lh wheels/arm64/*.whl 2>/dev/null | awk '{print $9, "(" $5 ")"}' || echo "No ARM64 wheels found"
          echo ""
          echo "=== Expected: 6 x86_64 wheels (cp38, cp39, cp310, cp311, cp312, cp313) ==="
          echo "=== Expected: 6 ARM64 wheels (cp38, cp39, cp310, cp311, cp312, cp313) ==="
          X86_COUNT=$(ls -1 wheels/x86_64/*.whl 2>/dev/null | wc -l | tr -d ' ')
          ARM64_COUNT=$(ls -1 wheels/arm64/*.whl 2>/dev/null | wc -l | tr -d ' ')
          echo "Found: $X86_COUNT x86_64 wheels, $ARM64_COUNT ARM64 wheels"
          if [ "$X86_COUNT" -lt 6 ] || [ "$ARM64_COUNT" -lt 6 ]; then
            echo "WARNING: Expected 12 wheels total, but found $((X86_COUNT + ARM64_COUNT))"
            echo "This may indicate that some builds failed or wheels were not renamed correctly"
          fi

      - name: Delete existing release (if any)
        # Delete existing release to allow overwriting with same tag
        run: |
          gh release delete "${{ github.event.inputs.tag }}" --yes 2>/dev/null || echo "No existing release to delete"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: Release ${{ github.event.inputs.version }}
          body: |
            Release ${{ github.event.inputs.version }}
            
            ## Wheels Included
            
            ### x86_64 (Intel Mac)
            - Python 3.8, 3.9, 3.10, 3.11, 3.12, 3.13
            
            ### ARM64 (Apple Silicon)
            - Python 3.8, 3.9, 3.10, 3.11, 3.12, 3.13
            
            ## Installation
            
            ```bash
            # For x86_64 (Intel Mac)
            pip install https://github.com/kimalive/pc-ble-driver-py/releases/download/${{ github.event.inputs.tag }}/pc_ble_driver_py-${{ github.event.inputs.version }}-cp312-abi3-macosx_26_0_x86_64.whl
            
            # For ARM64 (Apple Silicon)
            pip install https://github.com/kimalive/pc-ble-driver-py/releases/download/${{ github.event.inputs.tag }}/pc_ble_driver_py-${{ github.event.inputs.version }}-cp312-abi3-macosx_26_0_arm64.whl
            ```
            
            Replace `cp312` with your Python version (cp38, cp39, cp310, cp311, cp312, cp313).
          files: |
            wheels/x86_64/*.whl
            wheels/arm64/*.whl
          fail_on_unmatched_files: true
          draft: false
          prerelease: false
          make_latest: true

  build-arm64:
    name: Build ARM64 Wheels (Apple Silicon)
    runs-on: macos-latest  # macOS 15 ARM64 (Apple Silicon)
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Always use master for building (has latest fixes)
          # The tag is only used for the release name, not the code
          ref: master
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          ./bootstrap-vcpkg.sh

      - name: Install nrf-ble-driver (arm64-osx)
        run: |
          ./vcpkg/vcpkg install nrf-ble-driver --triplet arm64-osx

      - name: Install build dependencies
        run: |
          # Install SWIG (latest version - our fix works with both 4.3.x and 4.4.0)
          # We include Python.h and moduleobject.h in the %begin block to ensure compatibility
          brew install swig
          # Verify SWIG installation
          swig -version || echo "SWIG not found in PATH"
          which swig || echo "swig command not found"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scikit-build ninja cmake wrapt cryptography

      - name: Build ARM64 wheel
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          CMAKE_TOOLCHAIN_FILE: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
          CMAKE_PREFIX_PATH: ${{ github.workspace }}/vcpkg/installed/arm64-osx
        run: |
          # Clean _skbuild to ensure fresh build (prevents cross-version contamination)
          rm -rf _skbuild || true
          # Build wheel with explicit Python detection flags
          python setup.py bdist_wheel --build-type Release -- \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DPYTHON_EXECUTABLE="$(which python)" \
            -DPython3_EXECUTABLE="$(which python)" \
            -DPython3_ROOT_DIR="$(dirname $(dirname $(which python)))" \
            -DPython3_FIND_STRATEGY=LOCATION \
            -DPython3_FIND_REGISTRY=NEVER \
            -DPython3_FIND_VIRTUALENV=ONLY \
            -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON

      - name: Rename wheel to preserve Python version
        if: success()
        run: |
          # Find the wheel that was just built (it will have cp38-abi3 tag internally)
          WHEEL=$(ls -t dist/pc_ble_driver_py-*-cp38-abi3-*arm64*.whl 2>/dev/null | head -1)
          if [ -z "$WHEEL" ]; then
            # Fallback: try any cp*-abi3 pattern
            WHEEL=$(ls -t dist/pc_ble_driver_py-*-cp*-abi3-*arm64*.whl 2>/dev/null | head -1)
          fi
          if [ -z "$WHEEL" ]; then
            # Fallback: try without abi3 tag
            WHEEL=$(ls -t dist/pc_ble_driver_py-*-*arm64*.whl 2>/dev/null | head -1)
          fi
          if [ -n "$WHEEL" ] && [ -f "$WHEEL" ]; then
            # Extract Python version tag (e.g., "3.8" -> "cp38", "3.12" -> "cp312")
            PYTHON_TAG="cp${{ matrix.python-version }}"
            # Remove dots from version for tag (3.10 -> cp310)
            PYTHON_TAG=$(echo "$PYTHON_TAG" | sed 's/\.//g')
            # Get version from package __init__.py (most reliable)
            VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from pc_ble_driver_py import __version__; print(__version__)" 2>/dev/null)
            if [ -z "$VERSION" ]; then
              # Fallback: extract from wheel filename
              BASE_NAME=$(basename "$WHEEL" .whl)
              VERSION=$(echo "$BASE_NAME" | sed -n 's/.*pc_ble_driver_py-\([0-9.]*\)-.*/\1/p')
            fi
            if [ -z "$VERSION" ]; then
              echo "Error: Could not determine package version"
              exit 1
            fi
            # Create new name with correct Python tag
            NEW_WHEEL="dist/pc_ble_driver_py-${VERSION}-${PYTHON_TAG}-abi3-macosx_26_0_arm64.whl"
            if [ "$WHEEL" != "$NEW_WHEEL" ]; then
              echo "Renaming wheel to preserve Python version:"
              echo "  From: $(basename "$WHEEL")"
              echo "  To:   $(basename "$NEW_WHEEL")"
              mv "$WHEEL" "$NEW_WHEEL"
              WHEEL="$NEW_WHEEL"
            fi
            echo "Final wheel: $WHEEL"
          else
            echo "Error: No wheel found to rename"
            exit 1
          fi

      - name: Bundle dependencies into wheel
        if: success()
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_TRIPLET: arm64-osx
        run: |
          # Find the renamed wheel
          PYTHON_TAG="cp${{ matrix.python-version }}"
          PYTHON_TAG=$(echo "$PYTHON_TAG" | sed 's/\.//g')
          WHEEL=$(ls -t dist/pc_ble_driver_py-*-${PYTHON_TAG}-abi3-*arm64*.whl 2>/dev/null | head -1)
          if [ -z "$WHEEL" ]; then
            # Fallback: try any arm64 wheel
            WHEEL=$(ls -t dist/pc_ble_driver_py-*-*arm64*.whl 2>/dev/null | head -1)
          fi
          if [ -n "$WHEEL" ] && [ -f "$WHEEL" ]; then
            echo "Bundling dependencies into: $WHEEL"
            python ${{ github.workspace }}/bundle_into_wheel.py "$WHEEL" || echo "Bundling skipped (optional)"
          else
            echo "Warning: No wheel found to bundle"
          fi

      - name: Upload ARM64 wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-arm64-py${{ matrix.python-version }}
          path: dist/*.whl
          if-no-files-found: error
          retention-days: 1

