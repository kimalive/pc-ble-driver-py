# Tox configuration for pc-ble-driver-py
# Runs tests across multiple Python versions with isolated virtual environments

[tox]
# Python versions to test (3.8-3.13)
envlist = py38,py39,py310,py311,py312,py313

# Skip building from source package since we need CMAKE_TOOLCHAIN_FILE
# Use development installation instead
skipsdist = true

[testenv]
# Pass environment variables to test environment
passenv =
    VCPKG_ROOT
    CMAKE_TOOLCHAIN_FILE
    CMAKE_PREFIX_PATH
    PORT_A
    PORT_B
    NRF_FAMILY
    ITERATIONS
    LOG_LEVEL
    DRIVER_LOG_LEVEL
    BUILD_TYPE
    DYLD_LIBRARY_PATH

# Set runtime library path for macOS wheels (needed for nrf-ble-driver dependencies)
setenv =
    DYLD_LIBRARY_PATH = {env:VCPKG_ROOT}/installed/arm64-osx/lib:{env:DYLD_LIBRARY_PATH}

# Install dependencies
deps =
    # Build dependencies
    scikit-build
    ninja
    cmake
    # Python dependencies
    wrapt>=1.0.0
    cryptography>=3.0.0
    # Test dependencies
    unittest-xml-reporting
    # Note: xmlrunner is incompatible with Python 3.12+, so we use unittest-xml-reporting

# Commands to run in each test environment
# Note: By default, build from source (which works). Use TOX_USE_WHEELS=true to test wheels.
# CRITICAL: Test scripts now remove source directory from sys.path automatically
# This ensures Python imports from the installed wheel, not the source directory
commands =
    # CRITICAL: Clean old .so files first to prevent cross-version contamination
    # Each Python version needs its own .so files, but they share the same lib/ directory
    # This MUST run before any build or installation
    {envpython} -c "import glob, os, sys; lib_dir = 'pc_ble_driver_py/lib'; py_ver = f'{sys.version_info.major}.{sys.version_info.minor}'; files = glob.glob(os.path.join(lib_dir, '*.so')) + glob.glob(os.path.join(lib_dir, 'nrf_ble_driver_sd_api_*.py')); removed = [f for f in files if os.path.exists(f) and os.remove(f)]; print(f'ðŸ§¹ Cleaned {len(removed)} file(s) for Python {py_ver}') if removed else None" || true
    # Install package: use wheel if TOX_USE_WHEELS=true and wheel works, otherwise build from source
    {envpython} {toxinidir}/.tox_find_wheel.py
    # Run software-only tests (no hardware required)
    # Test scripts automatically remove source directory from sys.path
    {envpython} {toxinidir}/tests/test_wheel_compatibility.py
    {envpython} {toxinidir}/tests/test_cmake_rpath_config.py
    {envpython} {toxinidir}/tests/test_pc_ble_driver_py.py
    # Run hardware test if ports are provided (skip if not)
    {envpython} {toxinidir}/tests/run_hw_test_if_available.py

[testenv:py38]
basepython = python3.8

[testenv:py39]
basepython = python3.9

[testenv:py310]
basepython = python3.10

[testenv:py311]
basepython = python3.11

[testenv:py312]
basepython = python3.12

[testenv:py313]
basepython = python3.13

# Optional: Hardware tests on all Python versions
[testenv:test-hw]
# Hardware test with automatic device detection
envlist = py38,py39,py310,py311,py312,py313
commands =
    {envpython} {toxinidir}/.tox_find_wheel.py
    {envpython} {toxinidir}/tests/run_hw_test_if_available.py
deps =
    {[testenv]deps}

# Optional: Software-only tests (no hardware)
[testenv:test-software]
envlist = py38,py39,py310,py311,py312,py313
commands =
    {envpython} {toxinidir}/.tox_find_wheel.py
    {envpython} {toxinidir}/tests/test_wheel_compatibility.py
    {envpython} {toxinidir}/tests/test_cmake_rpath_config.py
    {envpython} {toxinidir}/tests/test_pc_ble_driver_py.py
deps =
    {[testenv]deps}
